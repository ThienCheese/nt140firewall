# Khối toàn cục (Global block)
{
    # Tắt HTTPS tự động vì Cloudflare Tunnel xử lý TLS
    auto_https off
}

# ==================================
# == Trang Hướng dẫn LAN (Port 8081)
# ==================================
:8081 {
    handle /clients/* {
        root * /app
        file_server
    }
    
    handle {
        root * /app/setup
        file_server
    }
}

# ==================================
# == Main Service - DoH & Dashboard
# ==================================
# Cloudflare Tunnel sẽ forward traffic đến đây
# TLS đã được Cloudflare xử lý, Caddy chỉ nhận HTTP
:80, :443 {
    # === Xử lý DoH ===
    handle /dns-query {
        reverse_proxy dns_server:8080
    }

    # === API và Dashboard ===
    handle /api/* {
        reverse_proxy dns_server:8000
    }
    
    # === Client files ===
    handle /clients/* {
        root * /app
        file_server
    }
    
    # === Dashboard (with auth) ===
    handle {
        root * /app/dashboard
        basicauth /* {
            admin {env.ADMIN_HASH_PASSWORD}
        }
        file_server
    }
}

# ==================================
# == DoT Support via Cloudflare Tunnel
# ==================================
# Cloudflare sẽ terminate TLS và forward TCP đến đây
:853 {
    # Không cần TLS vì Cloudflare đã xử lý
    # Chỉ cần proxy TCP stream đến Python DoT handler
    reverse_proxy dns_server:8053
}

# ==================================
# == Sinkhole Server (LAN only)
# ==================================
# Note: Port 80 đã dùng cho main service
# Sinkhole sẽ được serve qua subdomain hoặc path
# Tạm thời comment lại, có thể enable bằng cách:
# 1. Serve qua path: /sinkhole
# 2. Serve qua port khác: :8082
# 3. Serve qua subdomain riêng trong Cloudflare
# 
# Uncomment nếu muốn serve trên port riêng:
# :8082 {
#     root * /var/www/sinkhole
#     file_server
# }