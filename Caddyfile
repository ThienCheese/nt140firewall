# Khối toàn cục (Global block)
{
    # Tự động cấp chứng chỉ HTTPS cho các tên miền nội bộ và công cộng
    # Caddy sẽ sử dụng Lets Encrypt cho tên miền công cộng và tự ký cho tên miền nội bộ
    auto_https off
    
    # Server mặc định để xử lý các yêu cầu không khớp
    default_sni dns_firewall_server
}

# ==================================
# == (MỚI) Trang Hướng dẫn LAN (Không bảo mật)
# ==================================
# Truy cập qua http://<server_ip>:8081
:8081 {
    # Phục vụ các tệp Client
    handle /clients/* {
        root * /app
        file_server
    }
    
    # Phục vụ trang setup (mặc định)
    handle {
        root * /app/setup
        file_server
    }
}

# ==================================
# == Khối HTTP (DoH & Dashboard) cho Cloudflare
# ==================================
# Tên miền này sẽ được Cloudflare Tunnel trỏ đến Caddy
{$YOUR_DOMAIN_NAME} {
    # TLS sẽ được xử lý bởi Cloudflare, Caddy chỉ cần nhận HTTP
    
    # === Xử lý DoH ===
    handle /dns-query {
        reverse_proxy dns_server:8080
    }

    # === API và Dashboard ===
    handle /api/* {
        reverse_proxy dns_server:8000
    }
    
    # Phục vụ các tệp Client
    handle /clients/* {
        root * /app # Root là /app, Caddy sẽ tìm /app + /clients/...
        file_server
    }
    
    # Phục vụ các tệp tĩnh của Dashboard
    handle {
        root * /app/dashboard
        basicauth /\* {
            admin {$ADMIN_HASH}
        }
        file_server
    }
}

# ==================================
# == Khối DoT cho Cloudflare
# ==================================
# Cloudflare Tunnel sẽ chuyển tiếp lưu lượng TCP từ cổng 853
# đến Caddy trên cổng 853 nội bộ.
:853 {
    # Caddy sẽ tự tạo chứng chỉ nội bộ cho `dns_firewall_server`
    tls internal {
        on_demand
    }
    
    # Proxy lưu lượng TCP thô đến backend Python DoT
    reverse_proxy dns_server:8053
}

# ==================================
# == Khối Sinkhole Server cho LAN
# ==================================
:80 {
    root * /var/www/sinkhole
    file_server
}